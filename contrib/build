#!/bin/bash -x

function usage() {
	echo "build [-s] [-d]"
	echo "-s builds with selinux enabled"
	echo "-d builds/deploys systemd service with docker"
	exit 1
}

use_selinux=false
handle_systemd=false

while getopts "sd" o; do
	case "${o}" in
		s) use_selinux=true;;
        d) handle_systemd=true;;
		*) usage;;
	esac
done

tags=""

if $use_selinux; then
	tags="-tags selinux "
fi

#GOOS=linux GOARCH=amd64 go build -o geard.linux64 geard/main.go

if $handle_systemd; then
	docker build -rm -t ccoleman/geard /vagrant && sudo systemctl restart geard.service	
else
	go get ./...
	go install $tags github.com/smarterclayton/geard/cmd/gear
	go install $tags github.com/smarterclayton/geard/support/switchns
	go install $tags github.com/smarterclayton/geard/support/gear-auth-keys-command

	sudo /usr/bin/cp -f $GOPATH/bin/gear-auth-keys-command .
	sudo /usr/bin/cp -f $GOPATH/bin/switchns .
	sudo /usr/bin/cp -f $GOPATH/bin/gear /usr/bin/
fi
